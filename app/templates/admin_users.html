{% extends "base.html" %}

{% block content %}
<div class="container mx-auto mt-4">
  <h2 class="text-2xl font-bold text-white mb-4">👥 User Management</h2>

  <!-- Filters -->
  <form method="GET" action="{{ url_for('main.user_management') }}" class="flex flex-col sm:flex-row gap-4 mb-4 items-start sm:items-center">

    <!-- Company Filter -->
    <select name="company_id" onchange="this.form.submit()"
            class="w-full sm:w-64 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white">
      <option value="">🏢 Company Filter</option>
      {% for company in companies %}
      <option value="{{ company.id }}" {% if company.id == selected_company_id %}selected{% endif %}>
        {{ company.name }}
      </option>
      {% endfor %}
    </select>

    <!-- Add New User Button -->
    <a href="{{ url_for('main.add_user') }}"
       class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition ml-auto">
      ➕ Add New User
    </a>
  </form>

  <!-- Results Info -->
  <p class="text-sm text-gray-400 mb-2">
    Showing {{ users_start }} - {{ users_end }} of {{ total_users }} users
  </p>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full table-auto bg-gray-900 text-white border border-gray-800 rounded-lg shadow">
      <thead class="bg-gray-700 text-gray-200">
        <tr>
          <th class="px-4 py-2 text-left">Profile</th>
          <th class="px-4 py-2 text-left">Email</th>
          <th class="px-4 py-2 text-left">Company</th>
          <th class="px-4 py-2 text-left">Role</th>
          <th class="px-4 py-2 text-left">Status</th>
          <th class="px-4 py-2 text-left">Created</th>
          <th class="px-4 py-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr class="border-t border-gray-800">
          <td class="px-4 py-2 flex items-center gap-2">
            <img src="{{ url_for('static', filename='uploads/' ~ user.profile_picture) if user.profile_picture else url_for('static', filename='default-avatar.png') }}"
                 alt="Avatar" class="w-8 h-8 rounded-full object-cover">
            <span>{{ user.username }}</span>
          </td>
          <td class="px-4 py-2">{{ user.email }}</td>
          <td class="px-4 py-2">{{ user.company.name if user.company else '—' }}</td>
          <td class="px-4 py-2 capitalize">{{ user.role }}</td>
          <td class="px-4 py-2">
            {% if user.is_active %}
              <span class="text-green-700 bg-green-100 px-2 py-1 rounded text-sm">Active</span>
            {% else %}
              <span class="text-red-700 bg-red-100 px-2 py-1 rounded text-sm">Not active</span>
            {% endif %}
          </td>
          <td class="px-4 py-2">{{ user.created_at.strftime('%Y-%m-%d') }}</td>
          <td class="px-4 py-2 flex items-center gap-3">

            <!-- Show -->
            <a href="{{ url_for('main.view_user', user_id=user.id) }}" title="View" class="text-blue-400 hover:text-blue-600">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path fill-rule="evenodd" d="M4 4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H4Zm10 5a1 1 0 0 1 1-1h3a1 1 0 1 1 0 2h-3a1 1 0 0 1-1-1Zm0 3a1 1 0 0 1 1-1h3a1 1 0 1 1 0 2h-3a1 1 0 0 1-1-1Zm0 3a1 1 0 0 1 1-1h3a1 1 0 1 1 0 2h-3a1 1 0 0 1-1-1Zm-8-5a3 3 0 1 1 6 0 3 3 0 0 1-6 0Zm1.942 4a3 3 0 0 0-2.847 2.051l-.044.133-.004.012c-.042.126-.055.167-.042.195.006.013.02.023.038.039.032.025.08.064.146.155A1 1 0 0 0 6 17h6a1 1 0 0 0 .811-.415.713.713 0 0 1 .146-.155c.019-.016.031-.026.038-.04.014-.027 0-.068-.042-.194l-.004-.012-.044-.133A3 3 0 0 0 10.059 14H7.942Z" clip-rule="evenodd"/>
              </svg>
            </a>

            <!-- Edit -->
            <a href="{{ url_for('main.edit_user', user_id=user.id) }}" title="Edit" class="text-yellow-400 hover:text-yellow-600">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path fill-rule="evenodd" d="M5 8a4 4 0 1 1 7.796 1.263l-2.533 2.534A4 4 0 0 1 5 8Zm4.06 5H7a4 4 0 0 0-4 4v1a2 2 0 0 0 2 2h2.172a2.999 2.999 0 0 1-.114-1.588l.674-3.372a3 3 0 0 1 .82-1.533L9.06 13Zm9.032-5a2.907 2.907 0 0 0-2.056.852L9.967 14.92a1 1 0 0 0-.273.51l-.675 3.373a1 1 0 0 0 1.177 1.177l3.372-.675a1 1 0 0 0 .511-.273l6.07-6.07a2.91 2.91 0 0 0-.944-4.742A2.907 2.907 0 0 0 18.092 8Z" clip-rule="evenodd"/>
              </svg>
            </a>

            <!-- Delete -->
            <form method="POST" action="{{ url_for('main.delete_user', user_id=user.id) }}" class="inline">
              <button type="submit" onclick="return confirm('Are you sure you want to delete this user?')" title="Delete"
                      class="text-red-500 hover:text-red-700">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path fill-rule="evenodd" d="M8.586 2.586A2 2 0 0 1 10 2h4a2 2 0 0 1 2 2v2h3a1 1 0 1 1 0 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8a1 1 0 0 1 0-2h3V4a2 2 0 0 1 .586-1.414ZM10 6h4V4h-4v2Zm1 4a1 1 0 1 0-2 0v8a1 1 0 1 0 2 0v-8Zm4 0a1 1 0 1 0-2 0v8a1 1 0 1 0 2 0v-8Z" clip-rule="evenodd"/>
                </svg>
              </button>
            </form>

          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center py-4 text-gray-500">No users found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_numbers %}
  <div class="mt-4 flex justify-center gap-2">
    {% for p in page_numbers %}
      {% if p %}
        {% if p == current_page %}
        <span class="px-3 py-1 bg-blue-600 text-white rounded">{{ p }}</span>
        {% else %}
        <a href="{{ url_for('main.user_management', page=p, company_id=selected_company_id) }}"
           class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white">
          {{ p }}
        </a>
        {% endif %}
      {% else %}
        <span class="px-3 py-1 text-gray-500">…</span>
      {% endif %}
    {% endfor %}
  </div>
  {% endif %}

</div>
{% endblock %}





