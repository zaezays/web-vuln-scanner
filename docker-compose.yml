services:
  zap-daemon:
    image: zaproxy/zap-stable
    container_name: zap-daemon
    command: >
      zap.sh -daemon -host 0.0.0.0 -port 8080
      -config api.key=73d7metj7ni8583vnhf668epng
      -config api.addrs.addr.name=.*
      -config api.addrs.addr.regex=true
    ports:
      - "8080:8080"

  flask-scanner:
    build: .
    container_name: flask-scanner
    environment:
      - ZAP_API_KEY=73d7metj7ni8583vnhf668epng
      - ZAP_PROXY=http://zap-daemon:8080
      - REDIS_URL=redis://redis:6379/0               # ✅ add this
      - CELERY_BROKER_URL=redis://redis:6379/0       # ✅ add this
      - CELERY_RESULT_BACKEND=redis://redis:6379/0   # ✅ add this
    ports:
      - "5001:5001"
    volumes:
      - ./instance:/app/instance
      - /home/zae/Documents/web-vuln-scanner/static/uploads:/app/static/uploads
      - ./app/static/uploads:/app/static/uploads
      - /var/run/docker.sock:/var/run/docker.sock  
      - ./static:/app/static
      - ./data:/results     
      - ./app/static/reports:/app/static/reports
    depends_on:
      - zap-daemon
      - redis   

  redis:
      image: redis:7
      container_name: redis
      ports:
        - "6379:6379"

  celery-worker:
    build: .
    container_name: celery-worker
    command: celery -A app.tasks.celery worker --loglevel=info
    environment:
      - ZAP_API_KEY=73d7metj7ni8583vnhf668epng
      - ZAP_PROXY=http://zap-daemon:8080
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
      - zap-daemon
    volumes:
      - ./instance:/app/instance
      - ./app/static/uploads:/app/static/uploads
      - ./static:/app/static
      - ./data:/results


